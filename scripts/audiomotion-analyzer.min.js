/**!
 * audioMotion-analyzer
 * High-resolution real-time graphic audio spectrum analyzer JS module
 *
 * @version 4.5.0
 * @author  Henrique Avila Vianna <hvianna@gmail.com> <https://henriquevianna.com>
 * @license AGPL-3.0-or-later
 */
const VERSION="4.5.0",PI=Math.PI,TAU=2*PI,HALF_PI=PI/2,C_1=8.17579892,CANVAS_BACKGROUND_COLOR="#000",CHANNEL_COMBINED="dual-combined",CHANNEL_HORIZONTAL="dual-horizontal",CHANNEL_SINGLE="single",CHANNEL_VERTICAL="dual-vertical",COLOR_BAR_INDEX="bar-index",COLOR_BAR_LEVEL="bar-level",COLOR_GRADIENT="gradient",DEBOUNCE_TIMEOUT=60,EVENT_CLICK="click",EVENT_FULLSCREENCHANGE="fullscreenchange",EVENT_RESIZE="resize",GRADIENT_DEFAULT_BGCOLOR="#111",FILTER_NONE="",FILTER_A="A",FILTER_B="B",FILTER_C="C",FILTER_D="D",FILTER_468="468",FONT_FAMILY="sans-serif",FPS_COLOR="#0f0",LEDS_UNLIT_COLOR="#7f7f7f22",MODE_GRAPH=10,REASON_CREATE="create",REASON_FSCHANGE="fschange",REASON_LORES="lores",REASON_RESIZE="resize",REASON_USER="user",SCALEX_BACKGROUND_COLOR="#000c",SCALEX_LABEL_COLOR="#fff",SCALEX_HIGHLIGHT_COLOR="#4f4",SCALEY_LABEL_COLOR="#888",SCALEY_MIDLINE_COLOR="#555",SCALE_BARK="bark",SCALE_LINEAR="linear",SCALE_LOG="log",SCALE_MEL="mel",PRISM=["#a35","#c66","#e94","#ed0","#9d5","#4d8","#2cb","#0bc","#09c","#36b"],GRADIENTS=[["classic",{colorStops:["red",{color:"yellow",level:.85,pos:.6},{color:"lime",level:.475}]}],["prism",{colorStops:PRISM}],["rainbow",{dir:"h",colorStops:["#817",...PRISM,"#639"]}],["orangered",{bgColor:"#3e2f29",colorStops:["OrangeRed"]}],["steelblue",{bgColor:"#222c35",colorStops:["SteelBlue"]}]],DEFAULT_SETTINGS={alphaBars:!1,ansiBands:!1,barSpace:.1,bgAlpha:.7,channelLayout:"single",colorMode:"gradient",fadePeaks:!1,fftSize:8192,fillAlpha:1,frequencyScale:"log",gradient:GRADIENTS[0][0],gravity:3.8,height:void 0,ledBars:!1,linearAmplitude:!1,linearBoost:1,lineWidth:0,loRes:!1,lumiBars:!1,maxDecibels:-25,maxFPS:0,maxFreq:22e3,minDecibels:-85,minFreq:20,mirror:0,mode:0,noteLabels:!1,outlineBars:!1,overlay:!1,peakFadeTime:750,peakHoldTime:500,peakLine:!1,radial:!1,radialInvert:!1,radius:.3,reflexAlpha:.15,reflexBright:1,reflexFit:!0,reflexRatio:0,roundBars:!1,showBgColor:!0,showFPS:!1,showPeaks:!0,showScaleX:!0,showScaleY:!1,smoothing:.5,spinSpeed:0,splitGradient:!1,start:!0,trueLeds:!1,useCanvas:!0,volume:1,weightingFilter:"",width:void 0},ERR_AUDIO_CONTEXT_FAIL=["ERR_AUDIO_CONTEXT_FAIL","Could not create audio context. Web Audio API not supported?"],ERR_INVALID_AUDIO_CONTEXT=["ERR_INVALID_AUDIO_CONTEXT","Provided audio context is not valid"],ERR_UNKNOWN_GRADIENT=["ERR_UNKNOWN_GRADIENT","Unknown gradient"],ERR_FREQUENCY_TOO_LOW=["ERR_FREQUENCY_TOO_LOW","Frequency values must be >= 1"],ERR_INVALID_MODE=["ERR_INVALID_MODE","Invalid mode"],ERR_REFLEX_OUT_OF_RANGE=["ERR_REFLEX_OUT_OF_RANGE","Reflex ratio must be >= 0 and < 1"],ERR_INVALID_AUDIO_SOURCE=["ERR_INVALID_AUDIO_SOURCE","Audio source must be an instance of HTMLMediaElement or AudioNode"],ERR_GRADIENT_INVALID_NAME=["ERR_GRADIENT_INVALID_NAME","Gradient name must be a non-empty string"],ERR_GRADIENT_NOT_AN_OBJECT=["ERR_GRADIENT_NOT_AN_OBJECT","Gradient options must be an object"],ERR_GRADIENT_MISSING_COLOR=["ERR_GRADIENT_MISSING_COLOR","Gradient colorStops must be a non-empty array"];class AudioMotionError extends Error{constructor(e,t){const[i,s]=e;super(s+(void 0!==t?`: ${t}`:"")),this.name="AudioMotionError",this.code=i}}const deprecate=(e,t)=>console.warn(`${e} is deprecated. Use ${t} instead.`),isEmpty=e=>{for(const t in e)return!1;return!0},validateFromList=(e,t,i="toLowerCase")=>t[Math.max(0,t.indexOf((""+e)[i]()))],findY=(e,t,i,s,a)=>t+(s-t)*(a-e)/(i-e);Array.prototype.findLastIndex||(Array.prototype.findLastIndex=function(e){let t=this.length;for(;t-- >0;)if(e(this[t]))return t;return-1});class AudioMotionAnalyzer{constructor(e,t={}){this._ready=!1,this._aux={},this._canvasGradients=[],this._destroyed=!1,this._energy={val:0,peak:0,hold:0},this._flg={},this._fps=0,this._gradients={},this._last=0,this._outNodes=[],this._ownContext=!1,this._selectedGrads=[],this._sources=[],e instanceof Element||(isEmpty(t)&&!isEmpty(e)&&(t=e),e=null),this._ownCanvas=!(t.canvas instanceof HTMLCanvasElement);const i=this._ownCanvas?document.createElement("canvas"):t.canvas;i.style="max-width: 100%;",this._ctx=i.getContext("2d");for(const[e,t]of GRADIENTS)this.registerGradient(e,t);let s;if(this._container=e||!this._ownCanvas&&i.parentElement||document.body,this._defaultWidth=this._container.clientWidth||640,this._defaultHeight=this._container.clientHeight||270,t.source&&(s=t.source.context));else if(s=t.audioCtx);else try{s=new(window.AudioContext||window.webkitAudioContext),this._ownContext=!0}catch(e){throw new AudioMotionError(ERR_AUDIO_CONTEXT_FAIL)}if(!s.createGain)throw new AudioMotionError(ERR_INVALID_AUDIO_CONTEXT);const a=this._analyzer=[s.createAnalyser(),s.createAnalyser()],r=this._splitter=s.createChannelSplitter(2),n=this._merger=s.createChannelMerger(2);this._input=s.createGain(),this._output=s.createGain(),t.source&&this.connectInput(t.source);for(const e of[0,1])r.connect(a[e],e);n.connect(this._output),!1!==t.connectSpeakers&&this.connectOutput();for(const e of["_scaleX","_scaleR"])this[e]=document.createElement("canvas").getContext("2d");this._fsEl=t.fsElement||i;const o=()=>{this._fsTimeout||(this._fsTimeout=window.setTimeout((()=>{this._fsChanging||(this._setCanvas("resize"),this._fsTimeout=0)}),60))};window.ResizeObserver&&(this._observer=new ResizeObserver(o),this._observer.observe(this._container)),this._controller=new AbortController;const l=this._controller.signal;window.addEventListener("resize",o,{signal:l}),i.addEventListener("fullscreenchange",(()=>{this._fsChanging=!0,this._fsTimeout&&window.clearTimeout(this._fsTimeout),this._setCanvas("fschange"),this._fsTimeout=window.setTimeout((()=>{this._fsChanging=!1,this._fsTimeout=0}),60)}),{signal:l});const h=()=>{"suspended"==s.state&&s.resume(),window.removeEventListener("click",h)};window.addEventListener("click",h),document.addEventListener("visibilitychange",(()=>{"hidden"!=document.visibilityState&&(this._frames=0,this._time=performance.now())}),{signal:l}),this._setProps(t,!0),this.useCanvas&&this._ownCanvas&&this._container.appendChild(i),this._ready=!0,this._setCanvas("create")}get alphaBars(){return this._alphaBars}set alphaBars(e){this._alphaBars=!!e,this._calcBars()}get ansiBands(){return this._ansiBands}set ansiBands(e){this._ansiBands=!!e,this._calcBars()}get barSpace(){return this._barSpace}set barSpace(e){this._barSpace=+e||0,this._calcBars()}get channelLayout(){return this._chLayout}set channelLayout(e){this._chLayout=validateFromList(e,["single","dual-horizontal","dual-vertical","dual-combined"]),this._input.disconnect(),this._input.connect("single"!=this._chLayout?this._splitter:this._analyzer[0]),this._analyzer[0].disconnect(),this._outNodes.length&&this._analyzer[0].connect("single"!=this._chLayout?this._merger:this._output),this._calcBars(),this._makeGrad()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=validateFromList(e,["gradient","bar-index","bar-level"])}get fadePeaks(){return this._fadePeaks}set fadePeaks(e){this._fadePeaks=!!e}get fftSize(){return this._analyzer[0].fftSize}set fftSize(e){for(const t of[0,1])this._analyzer[t].fftSize=e;const t=this._analyzer[0].frequencyBinCount;this._fftData=[new Float32Array(t),new Float32Array(t)],this._calcBars()}get frequencyScale(){return this._frequencyScale}set frequencyScale(e){this._frequencyScale=validateFromList(e,["log","bark","mel","linear"]),this._calcBars()}get gradient(){return this._selectedGrads[0]}set gradient(e){this._setGradient(e)}get gradientLeft(){return this._selectedGrads[0]}set gradientLeft(e){this._setGradient(e,0)}get gradientRight(){return this._selectedGrads[1]}set gradientRight(e){this._setGradient(e,1)}get gravity(){return this._gravity}set gravity(e){this._gravity=e>0?+e:this._gravity||DEFAULT_SETTINGS.gravity}get height(){return this._height}set height(e){this._height=e,this._setCanvas("user")}get ledBars(){return this._showLeds}set ledBars(e){this._showLeds=!!e,this._calcBars()}get linearAmplitude(){return this._linearAmplitude}set linearAmplitude(e){this._linearAmplitude=!!e}get linearBoost(){return this._linearBoost}set linearBoost(e){this._linearBoost=e>=1?+e:1}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=+e||0}get loRes(){return this._loRes}set loRes(e){this._loRes=!!e,this._setCanvas("lores")}get lumiBars(){return this._lumiBars}set lumiBars(e){this._lumiBars=!!e,this._calcBars(),this._makeGrad()}get maxDecibels(){return this._analyzer[0].maxDecibels}set maxDecibels(e){for(const t of[0,1])this._analyzer[t].maxDecibels=e}get maxFPS(){return this._maxFPS}set maxFPS(e){this._maxFPS=e<0?0:+e||0}get maxFreq(){return this._maxFreq}set maxFreq(e){if(e<1)throw new AudioMotionError(ERR_FREQUENCY_TOO_LOW);this._maxFreq=Math.min(e,this.audioCtx.sampleRate/2),this._calcBars()}get minDecibels(){return this._analyzer[0].minDecibels}set minDecibels(e){for(const t of[0,1])this._analyzer[t].minDecibels=e}get minFreq(){return this._minFreq}set minFreq(e){if(e<1)throw new AudioMotionError(ERR_FREQUENCY_TOO_LOW);this._minFreq=+e,this._calcBars()}get mirror(){return this._mirror}set mirror(e){this._mirror=0|Math.sign(e),this._calcBars(),this._makeGrad()}get mode(){return this._mode}set mode(e){const t=0|e;if(!(t>=0&&t<=10&&9!=t))throw new AudioMotionError(ERR_INVALID_MODE,e);this._mode=t,this._calcBars(),this._makeGrad()}get noteLabels(){return this._noteLabels}set noteLabels(e){this._noteLabels=!!e,this._createScales()}get outlineBars(){return this._outlineBars}set outlineBars(e){this._outlineBars=!!e,this._calcBars()}get peakFadeTime(){return this._peakFadeTime}set peakFadeTime(e){this._peakFadeTime=e>=0?+e:this._peakFadeTime||DEFAULT_SETTINGS.peakFadeTime}get peakHoldTime(){return this._peakHoldTime}set peakHoldTime(e){this._peakHoldTime=+e||0}get peakLine(){return this._peakLine}set peakLine(e){this._peakLine=!!e}get radial(){return this._radial}set radial(e){this._radial=!!e,this._calcBars(),this._makeGrad()}get radialInvert(){return this._radialInvert}set radialInvert(e){this._radialInvert=!!e,this._calcBars(),this._makeGrad()}get radius(){return this._radius}set radius(e){this._radius=+e||0,this._calcBars(),this._makeGrad()}get reflexRatio(){return this._reflexRatio}set reflexRatio(e){if((e=+e||0)<0||e>=1)throw new AudioMotionError(ERR_REFLEX_OUT_OF_RANGE);this._reflexRatio=e,this._calcBars(),this._makeGrad()}get roundBars(){return this._roundBars}set roundBars(e){this._roundBars=!!e,this._calcBars()}get smoothing(){return this._analyzer[0].smoothingTimeConstant}set smoothing(e){for(const t of[0,1])this._analyzer[t].smoothingTimeConstant=e}get spinSpeed(){return this._spinSpeed}set spinSpeed(e){e=+e||0,void 0!==this._spinSpeed&&0!=e||(this._spinAngle=-HALF_PI),this._spinSpeed=e}get splitGradient(){return this._splitGradient}set splitGradient(e){this._splitGradient=!!e,this._makeGrad()}get stereo(){return deprecate("stereo","channelLayout"),"single"!=this._chLayout}set stereo(e){deprecate("stereo","channelLayout"),this.channelLayout=e?"dual-vertical":"single"}get trueLeds(){return this._trueLeds}set trueLeds(e){this._trueLeds=!!e}get volume(){return this._output.gain.value}set volume(e){this._output.gain.value=e}get weightingFilter(){return this._weightingFilter}set weightingFilter(e){this._weightingFilter=validateFromList(e,["","A","B","C","D","468"],"toUpperCase")}get width(){return this._width}set width(e){this._width=e,this._setCanvas("user")}get audioCtx(){return this._input.context}get canvas(){return this._ctx.canvas}get canvasCtx(){return this._ctx}get connectedSources(){return this._sources}get connectedTo(){return this._outNodes}get fps(){return this._fps}get fsHeight(){return this._fsHeight}get fsWidth(){return this._fsWidth}get isAlphaBars(){return this._flg.isAlpha}get isBandsMode(){return this._flg.isBands}get isDestroyed(){return this._destroyed}get isFullscreen(){return this._fsEl&&(document.fullscreenElement||document.webkitFullscreenElement)===this._fsEl}get isLedBars(){return this._flg.isLeds}get isLumiBars(){return this._flg.isLumi}get isOctaveBands(){return this._flg.isOctaves}get isOn(){return!!this._runId}get isOutlineBars(){return this._flg.isOutline}get pixelRatio(){return this._pixelRatio}get isRoundBars(){return this._flg.isRound}static get version(){return"4.5.0"}connectInput(e){const t=e instanceof HTMLMediaElement;if(!t&&!e.connect)throw new AudioMotionError(ERR_INVALID_AUDIO_SOURCE);const i=t?this.audioCtx.createMediaElementSource(e):e;return this._sources.includes(i)||(i.connect(this._input),this._sources.push(i)),i}connectOutput(e=this.audioCtx.destination){if(!this._outNodes.includes(e)&&(this._output.connect(e),this._outNodes.push(e),1==this._outNodes.length))for(const e of[0,1])this._analyzer[e].connect("single"!=this._chLayout||e?this._merger:this._output,0,e)}destroy(){if(!this._ready)return;const{audioCtx:e,canvas:t,_controller:i,_input:s,_merger:a,_observer:r,_ownCanvas:n,_ownContext:o,_splitter:l}=this;this._destroyed=!0,this._ready=!1,this.stop(),i.abort(),r&&r.disconnect(),this.onCanvasResize=null,this.onCanvasDraw=null,this._fsEl=null,this.disconnectInput(),this.disconnectOutput(),s.disconnect(),l.disconnect(),a.disconnect(),o&&e.close(),n&&t.remove(),this._calcBars()}disconnectInput(e,t){e?Array.isArray(e)||(e=[e]):e=Array.from(this._sources);for(const i of e){const e=this._sources.indexOf(i);if(t&&i.mediaStream)for(const e of i.mediaStream.getAudioTracks())e.stop();e>=0&&(i.disconnect(this._input),this._sources.splice(e,1))}}disconnectOutput(e){if((!e||this._outNodes.includes(e))&&(this._output.disconnect(e),this._outNodes=e?this._outNodes.filter((t=>t!==e)):[],0==this._outNodes.length))for(const e of[0,1])this._analyzer[e].disconnect()}getBars(){return Array.from(this._bars,(({posX:e,freq:t,freqLo:i,freqHi:s,hold:a,peak:r,value:n})=>({posX:e,freq:t,freqLo:i,freqHi:s,hold:a,peak:r,value:n})))}getEnergy(e,t){if(void 0===e)return this._energy.val;if(e!=+e){if("peak"==e)return this._energy.peak;const i={bass:[20,250],lowMid:[250,500],mid:[500,2e3],highMid:[2e3,4e3],treble:[4e3,16e3]};if(!i[e])return null;[e,t]=i[e]}const i=this._freqToBin(e),s=t?this._freqToBin(t):i,a="single"==this._chLayout?1:2;let r=0;for(let e=0;e<a;e++)for(let t=i;t<=s;t++)r+=this._normalizedB(this._fftData[e][t]);return r/(s-i+1)/a}getOptions(e){Array.isArray(e)||(e=[e]);let t={};for(const i of Object.keys(DEFAULT_SETTINGS))e.includes(i)||("gradient"==i&&this.gradientLeft!=this.gradientRight?(t.gradientLeft=this.gradientLeft,t.gradientRight=this.gradientRight):"start"!=i&&(t[i]=this[i]));return t}registerGradient(e,t){if("string"!=typeof e||0==e.trim().length)throw new AudioMotionError(ERR_GRADIENT_INVALID_NAME);if("object"!=typeof t)throw new AudioMotionError(ERR_GRADIENT_NOT_AN_OBJECT);const{colorStops:i}=t;if(!Array.isArray(i)||!i.length)throw new AudioMotionError(ERR_GRADIENT_MISSING_COLOR);const s=i.length,a=e=>+e!=e||e<0||e>1;i.forEach(((e,t)=>{const r=t/Math.max(1,s-1);"object"!=typeof e?i[t]={pos:r,color:e}:a(e.pos)&&(e.pos=r),a(e.level)&&(i[t].level=1-t/s)})),i.sort(((e,t)=>e.level<t.level?1:e.level>t.level?-1:0)),i[0].level=1,this._gradients[e]={bgColor:t.bgColor||"#111",dir:t.dir,colorStops:i},this._selectedGrads.includes(e)&&this._makeGrad()}setCanvasSize(e,t){this._width=e,this._height=t,this._setCanvas("user")}setFreqRange(e,t){if(e<1||t<1)throw new AudioMotionError(ERR_FREQUENCY_TOO_LOW);this._minFreq=Math.min(e,t),this.maxFreq=Math.max(e,t)}setLedParams(e){let t,i,s;e&&(t=0|e.maxLeds,i=+e.spaceV,s=+e.spaceH),this._ledParams=t>0&&i>0&&s>=0?[t,i,s]:void 0,this._calcBars()}setOptions(e){this._setProps(e)}setSensitivity(e,t){for(const i of[0,1])this._analyzer[i].minDecibels=Math.min(e,t),this._analyzer[i].maxDecibels=Math.max(e,t)}start(){this.toggleAnalyzer(!0)}stop(){this.toggleAnalyzer(!1)}toggleAnalyzer(e){const t=this.isOn;return void 0===e&&(e=!t),t&&!e?(cancelAnimationFrame(this._runId),this._runId=0):t||!e||this._destroyed||(this._frames=0,this._time=performance.now(),this._runId=requestAnimationFrame((e=>this._draw(e)))),this.isOn}toggleFullscreen(){if(this.isFullscreen)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{const e=this._fsEl;if(!e)return;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}}_binToFreq(e){return e*this.audioCtx.sampleRate/this.fftSize||1}_calcBars(){const e=this._bars=[];if(!this._ready)return void(this._flg={isAlpha:!1,isBands:!1,isLeds:!1,isLumi:!1,isOctaves:!1,isOutline:!1,isRound:!1,noLedGap:!1});const{_ansiBands:t,_barSpace:i,canvas:s,_chLayout:a,_maxFreq:r,_minFreq:n,_mirror:o,_mode:l,_radial:h,_radialInvert:_,_reflexRatio:c}=this,d=s.width>>1,u=s.height>>1,f="dual-vertical"==a&&!h,g="dual-horizontal"==a,p=l%10!=0,m=p&&"log"==this._frequencyScale,E=this._showLeds&&p&&!h,A=this._lumiBars&&p&&!h,R=this._alphaBars&&!A&&10!=l,L=this._outlineBars&&p&&!A&&!E,T=this._roundBars&&p&&!A&&!E,v="dual-vertical"!=a||c>0&&!A,w=s.height-(f&&!E?.5:0)>>f,y=w*(A||h?1:1-c)|0,S=s.width-d*(g||0!=o),C=f?s.height-2*w:0,b=d*(-1==o&&!g&&!h);let O=.375*Math.min(s.width,s.height)*("dual-vertical"==a?1:this._radius)|0,I=Math.min(d,u);_&&"dual-vertical"!=a&&([O,I]=[I,O]);const x=t=>e.push({...t,peak:[0,0],hold:[0],alpha:[0],value:[0]}),N=e=>{const t=this._freqToBin(e,"floor"),i=this._binToFreq(t),s=this._binToFreq(t+1);return[t,Math.log2(e/i)/Math.log2(s/i)]};let F,B,M;if(m){const i=(e,t,i)=>+e.toPrecision(i?Math.max(t,1+Math.log10(e)|0):t),s=e=>{const t=[1,1.12,1.25,1.4,1.6,1.8,2,2.24,2.5,2.8,3.15,3.55,4,4.5,5,5.6,6.3,7.1,8,9,10],i=0|Math.log10(e),s=e/10**i;let a=1;for(;a<t.length&&s>t[a];)a++;return s-t[a-1]<t[a]-s&&a--,(t[a]*10**(i+5)|0)/1e5},a=[0,24,12,8,6,4,3,2,1][l],o=t?10**(3/(10*a)):2**(1/a),h=o**.5;let _=t?7.94328235/(a%2?1:h):C_1;do{let e=_;const r=i(e/h,4,!0),l=i(e*h,4,!0),[c,d]=N(r),[u,f]=N(l);e=t?a<4?s(e):i(e,e.toString()[0]<5?3:2):i(e,4,!0),e>=n&&x({posX:0,freq:e,freqLo:r,freqHi:l,binLo:c,binHi:u,ratioLo:d,ratioHi:f}),_*=o}while(_<=r);F=S/e.length,e.forEach(((e,t)=>e.posX=b+t*F));const c=e[0],d=e[e.length-1];B=this._freqScaling(c.freqLo),M=S/(this._freqScaling(d.freqHi)-B),c.freqLo<n&&(c.freqLo=n,[c.binLo,c.ratioLo]=N(n)),d.freqHi>r&&(d.freqHi=r,[d.binHi,d.ratioHi]=N(r))}else if(p){const e=10*[0,24,12,8,6,4,3,2,1][l],t=e=>{switch(this._frequencyScale){case"bark":return 1960/(26.81/(e+.53)-1);case"mel":return 700*(2**e-1);case"linear":return e}};F=S/e,B=this._freqScaling(n),M=S/(this._freqScaling(r)-B);for(let i=0,s=0;i<e;i++,s+=F){const e=t(B+s/M),i=t(B+(s+F/2)/M),a=t(B+(s+F)/M),[r,n]=N(e),[o,l]=N(a);x({posX:b+s,freq:i,freqLo:e,freqHi:a,binLo:r,binHi:o,ratioLo:n,ratioHi:l})}}else{F=1,B=this._freqScaling(n),M=S/(this._freqScaling(r)-B);const t=this._freqToBin(n,"floor"),i=this._freqToBin(r);let s=-999;for(let a=t;a<=i;a++){const t=this._binToFreq(a),i=b+Math.round(M*(this._freqScaling(t)-B));if(i>s)x({posX:i,freq:t,freqLo:t,freqHi:t,binLo:a,binHi:a,ratioLo:0,ratioHi:0}),s=i;else if(e.length){const i=e[e.length-1];i.binHi=a,i.freqHi=t,i.freq=(i.freqLo*t)**.5}}}let k=0,D=0;if(E){const e=this._pixelRatio/(window.devicePixelRatio>1&&window.screen.height<=540?2:1),t=[[],[128,3,.45],[128,4,.225],[96,6,.225],[80,6,.225],[80,6,.125],[64,6,.125],[48,8,.125],[24,16,.125]],i=this._ledParams,[s,a,r]=i||t[l];let n,o=y;if(i){const t=2*e;let i;n=s+1;do{n--,i=o/n/(1+a),D=i*a}while((i<t||D<t)&&n>1)}else{const t=540/a;D=Math.min(a*e,Math.max(2,o/t+.1|0))}v&&(o+=D),i||(n=Math.min(s,o/(2*D)|0)),k=r>=1?r:F*r,this._leds=[n,k,D,o/n-D]}const G=Math.min(F-1,i*(i>0&&i<1?F:1));p&&(F-=Math.max(E?k:0,G)),e.forEach(((t,s)=>{let a=t.posX,r=F;p&&(0!=i||E?a+=Math.max(E?k:0,G)/2:(a|=0,r|=0,s>0&&a>e[s-1].posX+e[s-1].width&&(a--,r++)),t.posX=a),t.barCenter=a+(1==F?0:r/2),t.width=r}));const q=[];for(const e of[0,1]){const t="dual-vertical"==a?(w+C)*e:0,i=t+w,s=t+y-(!E||v?0:D);q.push({channelTop:t,channelBottom:i,analyzerBottom:s})}this._aux={analyzerHeight:y,analyzerWidth:S,centerX:d,centerY:u,channelCoords:q,channelHeight:w,channelGap:C,initialX:b,innerRadius:O,outerRadius:I,scaleMin:B,unitWidth:M},this._flg={isAlpha:R,isBands:p,isLeds:E,isLumi:A,isOctaves:m,isOutline:L,isRound:T,noLedGap:v},this._createScales()}_createScales(){if(!this._ready)return;const{analyzerWidth:e,initialX:t,innerRadius:i,scaleMin:s,unitWidth:a}=this._aux,{canvas:r,_frequencyScale:n,_mirror:o,_noteLabels:l,_radial:h,_scaleX:_,_scaleR:c}=this,d=_.canvas,u=c.canvas,f=[],g="dual-horizontal"==this._chLayout,p="dual-vertical"==this._chLayout,m=Math.min(r.width,r.height),E=["C",,"D",,"E","F",,"G",,"A",,"B"],A=m/34|0,R=d.height>>1,L=A>>1,T=R*(l?.7:1.5),v=L*(l?1:2);if(l||!this._ansiBands&&"log"==n){let e=C_1;for(let t=-1;t<11;t++)for(let i=0;i<12;i++){if(e>=this._minFreq&&e<=this._maxFreq){const s=E[i],a="C"==s;(s&&l&&!o&&!g||a)&&f.push(l?[e,s+(a?t:"")]:e)}e*=1.0594630943592953}}else f.push(16,31.5,63,125,250,500,1e3,2e3,4e3),"linear"==n?f.push(6e3,8e3,1e4,12e3,14e3,16e3,18e3,2e4,22e3):f.push(8e3,16e3);u.width=u.height=Math.max(.15*m,(i<<1)+p*A);const w=u.width>>1,y=w-.7*A,S=(e,t)=>{const i=TAU*(e/r.width),s=i-HALF_PI,a=y*Math.cos(s),n=y*Math.sin(s);c.save(),c.translate(w+a,w+n),c.rotate(i),c.fillText(t,0,0),c.restore()};d.width|=0,_.fillStyle=c.strokeStyle="#000c",_.fillRect(0,0,d.width,d.height),c.arc(w,w,w-A/2,0,TAU),c.lineWidth=A,c.stroke(),_.fillStyle=c.fillStyle="#fff",_.font=`${R}px ${FONT_FAMILY}`,c.font=`${L}px ${FONT_FAMILY}`,_.textAlign=c.textAlign="center";let C=-T/4,b=-v;for(const i of f){const[u,f]=Array.isArray(i)?i:[i,i<1e3?0|i:(i/100|0)/10+"k"],m=a*(this._freqScaling(u)-s),E=.75*d.height,A="C"==f[0],L=R*(!l||o||g?3:A?1.2:.6);if(_.fillStyle=c.fillStyle=!A||o||g?"#fff":"#4f4",l){const e="log"==n,t="linear"==n;let i=["C"];if((e||u>2e3||!t&&u>250||(!h||p)&&(!t&&u>125||u>1e3))&&i.push("G"),(e||u>4e3||!t&&u>500||(!h||p)&&(!t&&u>250||u>2e3))&&i.push("E"),(t&&u>4e3||(!h||p)&&(e||u>2e3||!t&&u>500))&&i.push("D","F","A","B"),!i.includes(f[0]))continue}m>=C+T/2&&m<=e&&(_.fillText(f,g&&-1==o?e-m:t+m,E,L),(g||o&&(m>T||1==o))&&_.fillText(f,g&&1!=o?e+m:(t||r.width)-m,E,L),C=m+Math.min(L,_.measureText(f).width)/2),m>=b+v&&m<e-v&&(S(g&&1==o?e-m:m,f),(g||o&&(m>v||1==o))&&S(g&&-1!=o?e+m:-m,f),b=m)}}_draw(e){this._runId=requestAnimationFrame((e=>this._draw(e)));const t=e-this._time,i=e-this._last,s=this._maxFPS?975/this._maxFPS:0;if(i<s)return;this._last=e-(s?i%s:0),this._frames++,t>=1e3&&(this._fps=this._frames/t*1e3,this._frames=0,this._time=e);const{isAlpha:a,isBands:r,isLeds:n,isLumi:o,isOctaves:l,isOutline:h,isRound:_,noLedGap:c}=this._flg,{analyzerHeight:d,centerX:u,centerY:f,channelCoords:g,channelHeight:p,channelGap:m,initialX:E,innerRadius:A,outerRadius:R}=this._aux,{_bars:L,canvas:T,_canvasGradients:v,_chLayout:w,_colorMode:y,_ctx:S,_energy:C,_fadePeaks:b,fillAlpha:O,_fps:I,_linearAmplitude:x,_lineWidth:N,maxDecibels:F,minDecibels:B,_mirror:M,_mode:k,overlay:D,_radial:G,showBgColor:q,showPeaks:z,useCanvas:H,_weightingFilter:P}=this,U=this._scaleX.canvas,X=this._scaleR.canvas,W=I*this._peakFadeTime/1e3,V=I**2,Y=1e3*this._gravity,$=I*this._peakHoldTime/1e3,K="dual-combined"==w,j="dual-horizontal"==w,Q="dual-vertical"==w,J="single"==w,Z=n&&this._trueLeds&&"gradient"==y,ee=G?T.width:this._aux.analyzerWidth,te=E+ee,ie=z&&this._peakLine&&10==k,se=G?R-A:d,ae=se/this._pixelRatio,[re,ne,oe,le]=this._leds||[];C.val>0&&I>0&&(this._spinAngle+=this._spinSpeed*TAU/60/I);const he=e=>{if(this._reflexRatio>0&&!o&&!G){let t,i;this.reflexFit||Q?(t=Q&&0==e?p+m:0,i=p-d):(t=T.height-2*d,i=d),S.save(),S.globalAlpha=this.reflexAlpha,1!=this.reflexBright&&(S.filter=`brightness(${this.reflexBright})`),S.setTransform(1,0,0,-1,0,T.height),S.drawImage(T,0,g[e].channelTop,T.width,d,0,t,T.width,i),S.restore()}},_e=()=>{this.showScaleX&&(G?(S.save(),S.translate(u,f),this._spinSpeed&&S.rotate(this._spinAngle+HALF_PI),S.drawImage(X,-X.width>>1,-X.width>>1),S.restore()):S.drawImage(U,0,T.height-U.height))},ce=e=>{const t=e**2,i=424.36,s=148693636,a=e=>20*Math.log10(e);switch(P){case"A":return 2+a(s*t**2/((t+i)*Math.sqrt((t+11599.29)*(t+544496.41))*(t+s)));case"B":return.17+a(s*t*e/((t+i)*Math.sqrt(t+25122.25)*(t+s)));case"C":return.06+a(s*t/((t+i)*(t+s)));case"D":const r=((1037918.48-t)**2+1080768.16*t)/((9837328-t)**2+11723776*t);return a(e/68966888496476e-18*Math.sqrt(r/((t+79919.29)*(t+1345600))));case"468":const n=-4737338981378384e-39*e**6+2043828333606125e-30*e**4-1.363894795463638e-7*t+1,o=1306612257412824e-34*e**5-2118150887518656e-26*e**3+.0005559488023498642*e;return 18.2+a(.0001246332637532143*e/Math.hypot(n,o))}return 0},de=(e,t,i)=>{S.beginPath(),S.moveTo(e,t),S.lineTo(e,i),S.stroke()},ue=e=>{if(e&&N){const e=S.globalAlpha;S.globalAlpha=1,S.stroke(),S.globalAlpha=e}},fe=e=>Math.max(0,(e*re|0)*(le+oe)-oe);D&&S.clearRect(0,0,T.width,T.height);let ge=0;const pe=L.length,me=J?1:2;for(let e=0;e<me;e++){const{channelTop:t,channelBottom:i,analyzerBottom:s}=g[e],r=this._gradients[this._selectedGrads[e]],l=r.colorStops,c=l.length,R=!q||n&&!D?"#000":r.bgColor,w=Q&&G&&e?-1:1,C=!e&&-1==M||e&&1==M,I=!j||e&&1!=M?0:ee>>(e||!C),X=j&&C?-1:1,J=()=>{const i=U.height,s=i>>1,a=x?100:F,r=x?0:B,n=x?20:5,o=d/(a-r),l=-1!=M&&(!j||0==e||1==M),h=1!=M&&(!j||e!=M);S.save(),S.fillStyle="#888",S.font=`${s}px ${FONT_FAMILY}`,S.textAlign="right",S.lineWidth=1;for(let e=a;e>r;e-=n){const r=t+(a-e)*o,n=e%2==0|0;if(n){const a=r+s*(r==t?.8:.35);l&&S.fillText(e,.85*i,a),h&&S.fillText(e,(j?ee:T.width)-.1*i,a),S.strokeStyle="#888",S.setLineDash([2,4]),S.lineDashOffset=0}else S.strokeStyle="#555",S.setLineDash([2,8]),S.lineDashOffset=1;S.beginPath(),S.moveTo(E+i*n*l,.5+~~r),S.lineTo(te-i*n*h,.5+~~r),S.stroke()}S.restore()},re=(e,t)=>{const i=Ae[e]+(e<Ae.length-1?(Ae[e+1]-Ae[e])*t:0);return isNaN(i)?-1/0:i},ne=(e,t=X)=>t*TAU*((e+I)/T.width)+this._spinAngle,_e=(e,t,i)=>{const s=A+t*w,a=ne(e,i);return[u+s*Math.cos(a),f+s*Math.sin(a)]},me=(e,t,i,s,a)=>{S.beginPath();for(const r of M&&!j?[1,-1]:[X]){const[n,o]=_?[ne(e,r),ne(e+i,r)]:[];S.moveTo(..._e(e,t,r)),S.lineTo(..._e(e,t+s,r)),_?S.arc(u,f,A+(t+s)*w,n,o,1!=r):S.lineTo(..._e(e+i,t+s,r)),S.lineTo(..._e(e+i,t,r)),_&&!a&&S.arc(u,f,A+t*w,o,n,1==r)}ue(a),S.fill()},Ee=(t=0,i=0)=>{let s;if("gradient"==y&&!Z||10==k)s=v[e];else{const e="bar-index"==y?i%c:l.findLastIndex((e=>n?fe(t)<=fe(e.level):t<=e.level));s=l[e].color}S.fillStyle=S.strokeStyle=s};if(H){if(j&&!G){const t=ee*(e+C),i=C?-1:1;S.setTransform(i,0,0,1,t,0)}if(D&&!q||(D&&(S.globalAlpha=this.bgAlpha),S.fillStyle=R,0!=e&&(G||K)||S.fillRect(E,t-m,ee,(D&&1==this.reflexAlpha?d:p)+m),S.globalAlpha=1),!this.showScaleY||o||G||0!=e&&K||J(),n?(S.setLineDash([le,oe]),S.lineWidth=L[0].width):S.lineWidth=h?Math.min(N,L[0].width/2):N,S.save(),!G){const e=new Path2D;e.rect(0,t,T.width,d),S.clip(e)}}let Ae=this._fftData[e];this._analyzer[e].getFloatFrequencyData(Ae),P&&(Ae=Ae.map(((e,t)=>e+ce(this._binToFreq(t))))),S.beginPath();let Re=[];for(let i=0;i<pe;i++){const r=L[i],{posX:d,barCenter:u,width:f,freq:g,binLo:p,binHi:m,ratioLo:R,ratioHi:T}=r;let v=Math.max(re(p,R),re(m,T));for(let e=p+1;e<m;e++)Ae[e]>v&&(v=Ae[e]);if(v=this._normalizedB(v),r.value[e]=v,ge+=v,r.peak[e]>0&&r.alpha[e]>0&&(r.hold[e]--,r.hold[e]<0)){if(b&&!ie){const t=!a||h&&N>0?1:a?r.peak[e]:O;r.alpha[e]=t*(1+r.hold[e]/W)}else r.peak[e]+=r.hold[e]*Y/V/ae;r.alpha[e]<=0&&(r.peak[e]=0)}if(v>=r.peak[e]&&(r.peak[e]=v,r.hold[e]=$,r.alpha[e]=!a||h&&N>0?1:a?v:O),!H)continue;S.globalAlpha=o||a?v:h?O:1,Ee(v,i);const w=o?se:n?fe(v):v*se|0;if(10==k){const e=i?0:(this._normalizedB(Ae[L[1].binLo])*se+w)/2;if(G){if(0==i&&(j&&S.moveTo(..._e(0,0)),S.lineTo(..._e(0,d<0?e:w))),d>=0){const e=[d,w];S.lineTo(..._e(...e)),Re.push(e)}}else{if(0==i)if(-1!=M||j){const e=p?this._normalizedB(Ae[p-1])*se:w;S.moveTo(E-N,s-e)}else S.moveTo(E,s-(d<E?e:w));(j||-1!=M||d>=E)&&S.lineTo(d,s-w)}}else if(n){if(q&&!D&&(0==e||!K)){const e=S.globalAlpha;S.strokeStyle="#7f7f7f22",S.globalAlpha=1,de(u,t,s),S.strokeStyle=S.fillStyle,S.globalAlpha=e}if(Z){const e=o?0:l.findLastIndex((e=>fe(v)<=fe(e.level)));let t=s;for(let i=c-1;i>=e;i--){S.strokeStyle=l[i].color;let a=s-(i==e?w:fe(l[i].level));de(u,t,a),t=a-oe}}else de(u,s,s-w)}else if(d>=E)if(G)me(d,0,f,w,h);else if(_){const e=f/2,t=s+e;S.beginPath(),S.moveTo(d,t),S.lineTo(d,t-w),S.arc(u,t-w,e,PI,TAU),S.lineTo(d+f,t),ue(h),S.fill()}else{const e=h?S.lineWidth:0;S.beginPath(),S.rect(d,s+e,f,-w-e),ue(h),S.fill()}const C=r.peak[e],I=r.alpha[e];if(C>0&&I>0&&z&&!ie&&!o&&d>=E&&d<te)if(b?S.globalAlpha=I:h&&N>0?S.globalAlpha=1:a&&(S.globalAlpha=C),("bar-level"==y||Z)&&Ee(C),n){const e=fe(C);e>=oe&&S.fillRect(d,s-e,f,le)}else if(G){if(10!=k){const e=C*se;me(d,e,f,!this._radialInvert||Q||e+A>=2?-2:2)}}else S.fillRect(d,s-C*se,f,2)}if(H){if(S.globalAlpha=1,10==k){if(Ee(),G&&!j){if(M){let e;for(;e=Re.pop();)S.lineTo(..._e(...e,-1))}S.closePath()}if(N>0&&S.stroke(),O>0){if(G){const e=j?ne(ee>>1):0,t=j?ne(ee):TAU;S.moveTo(..._e(j?ee>>1:0,0)),S.arc(u,f,A,e,t,!j||!C)}else S.lineTo(te,s),S.lineTo(E,s);S.globalAlpha=O,S.fill(),S.globalAlpha=1}if((ie||G&&z)&&(Re=[],S.beginPath(),L.forEach(((t,i)=>{let a=t.posX,r=t.peak[e],n=i?"lineTo":"moveTo";if(G&&a<0){const t=L[i+1];r=findY(a,r,t.posX,t.peak[e],0),a=0}r*=se,ie?(S[n](...G?_e(a,r):[a,s-r]),G&&M&&!j&&Re.push([a,r])):r>0&&me(a,r,1,-2)})),ie)){let e;for(;e=Re.pop();)S.lineTo(..._e(...e,-1));S.lineWidth=1,S.stroke()}}S.restore(),j&&!G&&S.setTransform(1,0,0,1,0,0),(!j&&!K||e)&&he(e)}}if((e=>{C.val=e,C.peak>0&&(C.hold--,C.hold<0&&(C.peak+=C.hold*Y/V/T.height*this._pixelRatio)),e>=C.peak&&(C.peak=e,C.hold=$)})(ge/(pe<<me-1)),H&&(!M||G||j||(S.setTransform(-1,0,0,1,T.width-E,0),S.drawImage(T,E,0,u,T.height,0,0,u,T.height),S.setTransform(1,0,0,1,0,0)),S.setLineDash([]),_e()),this.showFPS){const e=U.height;S.font=`bold ${e}px ${FONT_FAMILY}`,S.fillStyle="#0f0",S.textAlign="right",S.fillText(Math.round(I),T.width-e,2*e)}this.onCanvasDraw&&(S.save(),S.fillStyle=S.strokeStyle=v[0],this.onCanvasDraw(this,{timestamp:e,canvasGradients:v}),S.restore())}_freqScaling(e){switch(this._frequencyScale){case"log":return Math.log2(e);case"bark":return 26.81*e/(1960+e)-.53;case"mel":return Math.log2(1+e/700);case"linear":return e}}_freqToBin(e,t="round"){const i=this._analyzer[0].frequencyBinCount-1,s=Math[t](e*this.fftSize/this.audioCtx.sampleRate);return s<i?s:i}_makeGrad(){if(!this._ready)return;const{canvas:e,_ctx:t,_radial:i,_reflexRatio:s}=this,{analyzerWidth:a,centerX:r,centerY:n,initialX:o,innerRadius:l,outerRadius:h}=this._aux,{isLumi:_}=this._flg,c="dual-vertical"==this._chLayout,d=1-s,u=_?e.height:e.height*(1-s*!c)|0;for(const e of[0,1]){const f=this._gradients[this._selectedGrads[e]],g=f.colorStops,p="h"==f.dir;let m;if(m=i?t.createRadialGradient(r,n,h,r,n,l-(h-l)*c):t.createLinearGradient(...p?[o,0,o+a,0]:[0,0,0,u]),g){const e=c&&!this._splitGradient&&(!p||i);for(let t=0;t<1+e;t++){const a=g.length-1;g.forEach(((r,n)=>{let o=r.pos;if(e&&(o/=2),!c||_||i||p||(o*=d,!e&&o>.5*d&&(o+=.5*s)),1==t)if(i||_){o=1-(r=g[a-n]).pos/2}else 0==n&&o>0&&m.addColorStop(.5,r.color),o+=.5;m.addColorStop(o,r.color),c&&n==a&&o<.5&&m.addColorStop(.5,r.color)}))}}this._canvasGradients[e]=m}}_normalizedB(e){const t=this._linearAmplitude,i=t?1/this._linearBoost:1,s=e=>10**(e/20);let a=this.maxDecibels,r=this.minDecibels;return t&&(a=s(a),r=s(r),e=s(e)**i),l=1,(n=(e-r)/(a-r)**i)<=(o=0)?o:n>=l?l:n;var n,o,l}_setCanvas(e){if(!this._ready)return;const{canvas:t,_ctx:i}=this,s=this._scaleX.canvas,a=window.devicePixelRatio/(this._loRes+1);let r=window.screen.width*a,n=window.screen.height*a;90==Math.abs(window.orientation)&&r<n&&([r,n]=[n,r]);const o=this.isFullscreen,l=o&&this._fsEl==t,h=l?r:(this._width||this._container.clientWidth||this._defaultWidth)*a|0,_=l?n:(this._height||this._container.clientHeight||this._defaultHeight)*a|0;this._pixelRatio=a,this._fsWidth=r,this._fsHeight=n,"create"!=e&&t.width==h&&t.height==_||(t.width=h,t.height=_,this.overlay||(i.fillStyle="#000",i.fillRect(0,0,h,_)),i.lineJoin="bevel",s.width=h,s.height=Math.max(20*a,Math.min(h,_)/32|0),this._calcBars(),this._makeGrad(),void 0!==this._fsStatus&&this._fsStatus!==o&&(e="fschange"),this._fsStatus=o,this.onCanvasResize&&this.onCanvasResize(e,this))}_setGradient(e,t){if(!this._gradients.hasOwnProperty(e))throw new AudioMotionError(ERR_UNKNOWN_GRADIENT,e);[0,1].includes(t)||(this._selectedGrads[1]=e,t=0),this._selectedGrads[t]=e,this._makeGrad()}_setProps(e,t){const i=["onCanvasDraw","onCanvasResize"],s=Object.keys(DEFAULT_SETTINGS).filter((e=>"start"!=e)).concat(i,["gradientLeft","gradientRight","stereo"]);(t||void 0===e)&&(e={...DEFAULT_SETTINGS,...e});for(const t of Object.keys(e))i.includes(t)&&"function"!=typeof e[t]?this[t]=void 0:s.includes(t)&&(this[t]=e[t]);void 0!==e.start&&this.toggleAnalyzer(e.start)}}export{AudioMotionAnalyzer};export default AudioMotionAnalyzer;